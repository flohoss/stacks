name: renovate

on:
  workflow_dispatch:
  schedule:
    - cron: '0 15 * * *' # Every day at 15:00 UTC
  push:
    branches:
      - main

jobs:
  renovate:
    name: renovate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@lastest

      - name: Run Renovate
        uses: renovatebot/github-action@v46.0.1
        with:
          configurationFile: ${{ github.workspace }}/renovate.js
          docker-user: root
          # https://github.com/renovatebot/github-action?tab=readme-ov-file#token
          token: ${{ secrets.RENOVATE_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.RENOVATE_TOKEN }}
          RENOVATE_DOCKER_HUB_PASSWORD: ${{ secrets.DOCKER_HUB_PASSWORD }}
          RENOVATE_GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Open PRs and Notify
        env:
          GITHUB_TOKEN: ${{ secrets.RENOVATE_TOKEN }}
          NTFY_URL: ${{ secrets.NTFY_URL }}
          NTFY_TOKEN: ${{ secrets.NTFY_TOKEN }}
        run: |
          echo "Fetching open pull requests..."
          OPEN_PRS=$(gh pr list \
            --repo "${{ github.repository }}" \
            --state open \
            --assignee "${{ github.repository_owner }}" \
            --json number,title,url)

          if [ "$(echo "$OPEN_PRS" | jq length)" -gt 0 ]; then
            echo "Open PRs found, sending notifications..."
            echo "$OPEN_PRS" | jq -c '.[]' | while read -r pr; do
              NUMBER=$(echo "$pr" | jq -r '.number')
              TITLE=$(echo "$pr" | jq -r '.title')
              URL=$(echo "$pr" | jq -r '.url')

              curl -s -X POST "$NTFY_URL" \
                -H "Authorization: Bearer $NTFY_TOKEN" \
                -H "X-Tags: twisted_rightwards_arrows" \
                -H "X-Title: PR #${NUMBER} - ${TITLE}" \
                -H "X-Actions: view, Open PR, ${URL}" \
                -d "A Renovate PR needs your attention."
            done
          else
            echo "No open pull requests found."
          fi
